# AWS ì¸ìŠ¤í„´ìŠ¤ ë°°í¬ ìë™í™” ì›Œí¬í”Œë¡œìš° (ALB + Bastion Host ì•„í‚¤í…ì²˜)
# 
# ì‹¤í–‰ ë°©ë²•:
# 1. ìˆ˜ë™ ì‹¤í–‰: GitHub Actionsì—ì„œ "Run workflow"ë¡œ ì‹¤í–‰ ì‹œ Bastion Host IPì™€ ë„ë©”ì¸ ì…ë ¥
# 2. ìë™ ì‹¤í–‰: main ë¸Œëœì¹˜ì— push/merge ì‹œ ìë™ ë°°í¬ (BASTION_IP, DOMAIN_NAME secret í•„ìš”)
# 3. í…ŒìŠ¤íŠ¸ ì‹¤í–‰: feature/cd ë¸Œëœì¹˜ì— push ì‹œ í…ŒìŠ¤íŠ¸ìš© ìë™ ì‹¤í–‰
#
# ì•„í‚¤í…ì²˜:
# - Public Subnet: ALB, NAT Gateway, Bastion Host
# - Private Subnet: Service Instance (Frontend, Backend, AI, DB)
# - Route53 + ACMìœ¼ë¡œ ë„ë©”ì¸ ì¸ì¦ì„œ ê´€ë¦¬
# - ALBë¡œ Frontend(/) ì™€ API(/api) ë¼ìš°íŒ… ë¶„ë¦¬

name: CD Pipeline

on:
  # ìˆ˜ë™ ì‹¤í–‰ (Bastion Host IPì™€ ë„ë©”ì¸ ì…ë ¥)
  workflow_dispatch:
    inputs:
      bastion_ip:
        description: 'Bastion Host Public IP Address (ì˜ˆ: 13.124.123.45)'
        required: true
        type: string
      domain_name:
        description: 'Service Domain Name (ì˜ˆ: api.example.com)'
        required: true
        type: string
      service_instance_ip:
        description: 'Private Service Instance IP (ì˜ˆ: 10.0.3.10)'
        required: true
        type: string
  
  # main ë¸Œëœì¹˜ì— push ì‹œ ìë™ ë°°í¬
  push:
    branches:
      - feature/cd
  
  # main ë¸Œëœì¹˜ë¡œ PRì´ mergeë  ë•Œ ìë™ ë°°í¬
  pull_request:
    branches:
      - main
    types:
      - closed

permissions:
  contents: read
  pull-requests: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    # PRì´ mergedëœ ê²½ìš°ë‚˜ ì§ì ‘ pushëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    env:
      # í™˜ê²½ë³€ìˆ˜ ì„¤ì •: workflow_dispatchì¼ ë•ŒëŠ” ì…ë ¥ë°›ì€ ê°’ ì‚¬ìš©, ìë™ ì‹¤í–‰ì‹œì—” secrets ì‚¬ìš©
      BASTION_IP: ${{ github.event.inputs.bastion_ip || secrets.BASTION_IP }}
      DOMAIN_NAME: ${{ github.event.inputs.domain_name || secrets.DOMAIN_NAME }}
      SERVICE_INSTANCE_IP: ${{ github.event.inputs.service_instance_ip || secrets.SERVICE_INSTANCE_IP }}
    
    steps:
    # ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN }}

    # AWS ì¸ì¦ ì„¤ì •
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    # ECR ë¡œê·¸ì¸
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    # ê¸°ì¡´ ECR ì´ë¯¸ì§€ ì‚­ì œ (ìš©ëŸ‰ ì ˆì•½)
    - name: Delete existing ECR images (if any)
      run: |
        echo "Deleting existing images..."
        aws ecr batch-delete-image --repository-name mt-frontend --image-ids imageTag=latest --region ${{ secrets.AWS_REGION }} || true
        aws ecr batch-delete-image --repository-name mt-backend --image-ids imageTag=latest --region ${{ secrets.AWS_REGION }} || true
        aws ecr batch-delete-image --repository-name mt-ai --image-ids imageTag=latest --region ${{ secrets.AWS_REGION }} || true
        aws ecr batch-delete-image --repository-name mt-db --image-ids imageTag=latest --region ${{ secrets.AWS_REGION }} || true

    # í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ (ë„ë©”ì¸ ê¸°ë°˜ URL ì£¼ì…)
    - name: Build and push Frontend image
      run: |
        echo "Building Frontend with domain: ${{ env.DOMAIN_NAME }}"
        docker build \
          --build-arg NEXT_PUBLIC_BACKEND_URL=https://${{ env.DOMAIN_NAME }} \
          -t ${{ secrets.ECR_REGISTRY }}/mt-frontend:latest \
          ./frontend
        docker push ${{ secrets.ECR_REGISTRY }}/mt-frontend:latest

    # ë°±ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    - name: Build and push Backend image
      run: |
        echo "Building Backend..."
        docker build -t ${{ secrets.ECR_REGISTRY }}/mt-backend:latest ./backend
        docker push ${{ secrets.ECR_REGISTRY }}/mt-backend:latest

    # AI ì„œë¹„ìŠ¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    - name: Build and push AI image
      run: |
        echo "Building AI service..."
        docker build -t ${{ secrets.ECR_REGISTRY }}/mt-ai:latest ./ai
        docker push ${{ secrets.ECR_REGISTRY }}/mt-ai:latest

    # ë°ì´í„°ë² ì´ìŠ¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    - name: Build and push DB image
      run: |
        echo "Building Database..."
        docker build -t ${{ secrets.ECR_REGISTRY }}/mt-db:latest ./db
        docker push ${{ secrets.ECR_REGISTRY }}/mt-db:latest

    # docker-compose.production.ymlì— í™˜ê²½ë³€ìˆ˜ ì£¼ì…
    - name: Configure docker-compose with secrets
      run: |
        # GitHub Secretsì„ ì‚¬ìš©í•˜ì—¬ í™˜ê²½ë³€ìˆ˜ ì¹˜í™˜
        # Frontend í™˜ê²½ë³€ìˆ˜ (ALBë¥¼ í†µí•œ ë„ë©”ì¸ ê¸°ë°˜ ì ‘ê·¼)
        sed -i "s|\${NEXT_PUBLIC_BACKEND_URL}|https://${{ env.DOMAIN_NAME }}|g" docker-compose.production.yml
        
        # Backend í™˜ê²½ë³€ìˆ˜  
        sed -i "s|\${BACKEND_PORT}|${{ secrets.BACKEND_PORT }}|g" docker-compose.production.yml
        sed -i "s|\${DB_NAME}|${{ secrets.DB_NAME }}|g" docker-compose.production.yml
        sed -i "s|\${DB_USER}|${{ secrets.DB_USER }}|g" docker-compose.production.yml
        sed -i "s|\${DB_PASSWORD}|${{ secrets.DB_PASSWORD }}|g" docker-compose.production.yml
        sed -i "s|\${JWT_SECRET_KEY}|${{ secrets.JWT_SECRET_KEY }}|g" docker-compose.production.yml
        sed -i "s|\${GOOGLE_CLIENT_ID}|${{ secrets.GOOGLE_CLIENT_ID }}|g" docker-compose.production.yml
        sed -i "s|\${GOOGLE_CLIENT_SECRET}|${{ secrets.GOOGLE_CLIENT_SECRET }}|g" docker-compose.production.yml
        sed -i "s|\${KAKAO_CLIENT_ID}|${{ secrets.KAKAO_CLIENT_ID }}|g" docker-compose.production.yml
        sed -i "s|\${KAKAO_CLIENT_SECRET}|${{ secrets.KAKAO_CLIENT_SECRET }}|g" docker-compose.production.yml
        sed -i "s|\${NAVER_CLIENT_ID}|${{ secrets.NAVER_CLIENT_ID }}|g" docker-compose.production.yml
        sed -i "s|\${NAVER_CLIENT_SECRET}|${{ secrets.NAVER_CLIENT_SECRET }}|g" docker-compose.production.yml
        sed -i "s|\${AWS_ACCESS_KEY_ID}|${{ secrets.AWS_ACCESS_KEY_ID }}|g" docker-compose.production.yml
        sed -i "s|\${AWS_SECRET_ACCESS_KEY}|${{ secrets.AWS_SECRET_ACCESS_KEY }}|g" docker-compose.production.yml
        sed -i "s|\${AWS_S3_REGION}|${{ secrets.AWS_S3_REGION }}|g" docker-compose.production.yml
        sed -i "s|\${AWS_S3_BUCKET_NAME}|${{ secrets.AWS_S3_BUCKET_NAME }}|g" docker-compose.production.yml
        sed -i "s|\${AI_SERVICE_URL}|${{ secrets.AI_SERVICE_URL }}|g" docker-compose.production.yml
        sed -i "s|\${TOSS_SECRET_KEY}|${{ secrets.TOSS_SECRET_KEY }}|g" docker-compose.production.yml
        sed -i "s|\${NEXT_PUBLIC_TOSS_CLIENT_KEY}|${{ secrets.NEXT_PUBLIC_TOSS_CLIENT_KEY }}|g" docker-compose.production.yml
        sed -i "s|\${NAVER_API_CLIENT_ID}|${{ secrets.NAVER_API_CLIENT_ID }}|g" docker-compose.production.yml
        sed -i "s|\${NAVER_API_CLIENT_SECRET}|${{ secrets.NAVER_API_CLIENT_SECRET }}|g" docker-compose.production.yml
        
        # AI ì„œë¹„ìŠ¤ í™˜ê²½ë³€ìˆ˜
        sed -i "s|\${DB_PORT}|${{ secrets.DB_PORT }}|g" docker-compose.production.yml
        sed -i "s|\${OPENAI_API_KEY}|${{ secrets.OPENAI_API_KEY }}|g" docker-compose.production.yml
        sed -i "s|\${OPENAI_MODEL}|${{ secrets.OPENAI_MODEL }}|g" docker-compose.production.yml
        sed -i "s|\${OPENAI_IMAGE_MODEL}|${{ secrets.OPENAI_IMAGE_MODEL }}|g" docker-compose.production.yml
        sed -i "s|\${OPENAI_BREEDING_MODEL}|${{ secrets.OPENAI_BREEDING_MODEL }}|g" docker-compose.production.yml
        sed -i "s|\${EMBEDDING_MODEL_NAME}|${{ secrets.EMBEDDING_MODEL_NAME }}|g" docker-compose.production.yml
        sed -i "s|\${VECTORSTORE_COLLECTION_NAME}|${{ secrets.VECTORSTORE_COLLECTION_NAME }}|g" docker-compose.production.yml
        sed -i "s|\${VECTORSTORE_DISTANCE_STRATEGY}|${{ secrets.VECTORSTORE_DISTANCE_STRATEGY }}|g" docker-compose.production.yml
        sed -i "s|\${VECTORSTORE_SEARCH_LIMIT}|${{ secrets.VECTORSTORE_SEARCH_LIMIT }}|g" docker-compose.production.yml
        sed -i "s|\${SAMPLE_DATA_PATH}|${{ secrets.SAMPLE_DATA_PATH }}|g" docker-compose.production.yml
        sed -i "s|\${PROMPT_TEMPLATE_PATH}|${{ secrets.PROMPT_TEMPLATE_PATH }}|g" docker-compose.production.yml
        
        # OAuth2 ë° Frontend URL í™˜ê²½ë³€ìˆ˜ (ìƒˆë¡œ ì¶”ê°€ëœ ë³€ìˆ˜ë“¤)
        sed -i "s|OAUTH2_REDIRECT_URI_BASE=https://meongtory.shop|OAUTH2_REDIRECT_URI_BASE=https://${{ env.DOMAIN_NAME }}|g" docker-compose.production.yml
        sed -i "s|FRONTEND_URL=https://meongtory.shop|FRONTEND_URL=https://${{ env.DOMAIN_NAME }}|g" docker-compose.production.yml
        
        echo "Configured docker-compose.production.yml with environment variables"
        echo "Final docker-compose configuration:"
        cat docker-compose.production.yml

    # Service Instance ì •ë¦¬ ì‘ì—… (Bastionì„ í†µí•œ í„°ë„ë§)
    - name: Clean up service instance via bastion
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.BASTION_IP }}
        username: ubuntu
        key: ${{ secrets.AWS_PEM_KEY }}
        script: |
          echo "Setting up service instance key..."
          
          # Service instance SSH í‚¤ ì„¤ì •
          echo "${{ secrets.AWS_PEM_KEY }}" > /tmp/service_key.pem
          chmod 600 /tmp/service_key.pem
          
          echo "Connecting to service instance to cleanup..."
          
          # Bastionì—ì„œ Service Instanceë¡œ SSH í„°ë„ë§í•˜ì—¬ ì •ë¦¬ ì‘ì—…
          ssh -o StrictHostKeyChecking=no -i /tmp/service_key.pem ubuntu@${{ env.SERVICE_INSTANCE_IP }} << 'EOF'
            echo "Starting cleanup on service instance..."
            
            # Stop existing containers
            if [ -f docker-compose.yml ]; then
              echo "Stopping existing containers..."
              docker-compose down || true
            fi
            
            # Clean up old files
            rm -rf docker-compose.yml init-db/
            
            # Clean up Docker resources
            echo "Cleaning up Docker resources..."
            docker system prune -f || true
            
            echo "Cleanup completed on service instance"
          EOF
          
          # ë³´ì•ˆì„ ìœ„í•´ í‚¤ íŒŒì¼ ì‚­ì œ
          rm -f /tmp/service_key.pem

    # ë°°í¬ íŒŒì¼ì„ Bastion Hostì— ë¨¼ì € ì „ì†¡
    - name: Copy files to bastion host
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ env.BASTION_IP }}
        username: ubuntu
        key: ${{ secrets.AWS_PEM_KEY }}
        source: "docker-compose.production.yml,db/init-db"
        target: "/home/ubuntu/"

    # Bastion Hostì—ì„œ Service Instanceë¡œ íŒŒì¼ ì „ì†¡ ë° ì„œë¹„ìŠ¤ ì‹œì‘
    - name: Deploy to service instance via bastion
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.BASTION_IP }}
        username: ubuntu
        key: ${{ secrets.AWS_PEM_KEY }}
        script: |
          echo "Setting up service instance key..."
          
          # Service instance SSH í‚¤ ì„¤ì •
          echo "${{ secrets.AWS_PEM_KEY }}" > /tmp/service_key.pem
          chmod 600 /tmp/service_key.pem
          
          echo "Copying deployment files to service instance..."
          
          # ë°°í¬ íŒŒì¼ì„ service instanceë¡œ ì „ì†¡
          scp -o StrictHostKeyChecking=no -i /tmp/service_key.pem docker-compose.production.yml ubuntu@${{ env.SERVICE_INSTANCE_IP }}:/home/ubuntu/
          scp -o StrictHostKeyChecking=no -i /tmp/service_key.pem -r db/init-db ubuntu@${{ env.SERVICE_INSTANCE_IP }}:/home/ubuntu/
          
          echo "Connecting to service instance to start services..."
          
          # Service instanceì—ì„œ ì„œë¹„ìŠ¤ ì‹œì‘
          ssh -o StrictHostKeyChecking=no -i /tmp/service_key.pem ubuntu@${{ env.SERVICE_INSTANCE_IP }} << 'EOF'
            echo "Renaming docker-compose file..."
            mv docker-compose.production.yml docker-compose.yml
            
            echo "Starting services on service instance..."
            
            # Configure AWS CLI for ECR access
            aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws configure set default.region ${{ secrets.AWS_REGION }}
            
            # Login to ECR
            aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}
            
            # Pull latest images
            echo "Pulling latest images..."
            docker pull ${{ secrets.ECR_REGISTRY }}/mt-frontend:latest
            docker pull ${{ secrets.ECR_REGISTRY }}/mt-backend:latest
            docker pull ${{ secrets.ECR_REGISTRY }}/mt-ai:latest
            docker pull ${{ secrets.ECR_REGISTRY }}/mt-db:latest
            
            # Start services
            echo "Starting services with docker-compose..."
            docker-compose up -d
            
            # Show running containers
            echo "Deployment completed. Running containers:"
            docker ps
            
            echo "Services started successfully on service instance"
          EOF
          
          # ë³´ì•ˆì„ ìœ„í•´ í‚¤ íŒŒì¼ ì‚­ì œ
          rm -f /tmp/service_key.pem

    # ë°°í¬ ì™„ë£Œ ìƒíƒœ ì¶œë ¥
    - name: Deployment Status
      run: |
        echo "ğŸš€ Deployment completed successfully!"
        echo "ğŸ“ Architecture: ALB + Bastion Host + Private Subnet"
        echo ""
        echo "ğŸŒ Public Access URLs:"
        echo "  Frontend: https://${{ env.DOMAIN_NAME }}"
        echo "  API: https://${{ env.DOMAIN_NAME }}/api"
        echo ""
        echo "ğŸ”§ Infrastructure Details:"
        echo "  Bastion Host: ${{ env.BASTION_IP }}"
        echo "  Service Instance (Private): ${{ env.SERVICE_INSTANCE_IP }}"
        echo "  Load Balancer: Managed by ALB"
        echo ""
        echo "ğŸ“‹ Services Status:"
        echo "  âœ… Frontend (Port 3000) - Routed via ALB"
        echo "  âœ… Backend (Port 8080) - Routed via ALB (/api)"  
        echo "  âœ… AI Service (Port 9000) - Internal"
        echo "  âœ… Database (Port 5432) - Internal"
        echo ""
        echo "ğŸ” Security:"
        echo "  âœ… SSL/TLS Certificate (ACM)"
        echo "  âœ… Private subnet isolation"
        echo "  âœ… Bastion host access only"